<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <title>User Agent Interaction with Related Website Sets</title>
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <link href="https://www.w3.org/StyleSheets/TR/2021/cg-draft" rel="stylesheet">
  <meta content="Bikeshed version b25686b9f, updated Fri Mar 14 14:15:20 2025 -0700" name="generator">
  <link href="https://wicg.github.io/first-party-sets/" rel="canonical">
  <meta content="41975cf9b4490c376a8eaff3e2738b14c999cf7a" name="revision">
  <meta content="dark light" name="color-scheme">
  <link href="https://www.w3.org/StyleSheets/TR/2021/dark.css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css">
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */
/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
    --dfnpanel-target-bg: #ffc;
    --dfnpanel-target-outline: orange;
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
        --dfnpanel-target-bg: #333;
        --dfnpanel-target-outline: silver;
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel a:focus {
    outline: 5px auto Highlight;
    outline: 5px auto -webkit-focus-ring-color;
}
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: 8px;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
    transition: left 1s ease-out, bottom 1s ease-out;
}

.dfn-panel .link-item:hover {
    text-decoration: underline;
}
.dfn-panel .link-item .copy-icon {
    opacity: 0;
}
.dfn-panel .link-item:hover .copy-icon,
.dfn-panel .link-item .copy-icon:focus {
    opacity: 1;
}

.dfn-panel .copy-icon {
    display: inline-block;
    margin-right: 0.5em;
    width: 0.85em;
    height: 1em;
    border-radius: 3px;
    background-color: #ccc;
    cursor: pointer;
}

.dfn-panel .copy-icon .icon {
    width: 100%;
    height: 100%;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

.dfn-panel .copy-icon .icon::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 1px solid black;
    background-color: #ccc;
    opacity: 0.25;
    transform: translate(3px, -3px);
}

.dfn-panel .copy-icon:active .icon::before {
    opacity: 1;
}

.dfn-paneled[role="button"] { cursor: help; }

.highlighted {
    animation: target-fade 3s;
}

@keyframes target-fade {
    from {
        background-color: var(--dfnpanel-target-bg);
        outline: 5px solid var(--dfnpanel-target-outline);
    }
    to {
        color: var(--a-normal-text);
        background-color: transparent;
        outline: transparent;
    }
}
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-ref-hints */
:root {
    --ref-hint-bg: #ddd;
    --ref-hint-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --ref-hint-bg: #222;
        --ref-hint-text: var(--text);
    }
}

.ref-hint {
    display: inline-block;
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.5em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--ref-hint-bg);
    color: var(--ref-hint-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}

.ref-hint * { margin: 0; padding: 0; text-indent: 0; }

.ref-hint ul { padding: 0 0 0 1em; list-style: none; }
</style>
<style>/* Boilerplate: style-selflinks */
:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
   <h1 class="p-name no-ref" id="title">User Agent Interaction with Related Website Sets</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types/#CG-DRAFT">Draft Community Group Report</a>, <time class="dt-updated" datetime="2025-03-19">19 March 2025</time></p>
   <div data-fill-with="spec-metadata">
    <dl>
     <dt>This version:
     <dd><a class="u-url" href="https://wicg.github.io/first-party-sets/">https://wicg.github.io/first-party-sets/</a>
     <dt>Issue Tracking:
     <dd><a href="https://github.com/WICG/first-party-sets/issues/">GitHub</a>
     <dd><a href="#issues-index">Inline In Spec</a>
     <dt class="editor">Editors:
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:cfredric@google.com">Chris Fredrickson</a> (<a class="p-org org" href="https://google.com">Google</a>)
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:kaustubhag@google.com">Kaustubha Govind</a> (<a class="p-org org" href="https://google.com">Google</a>)
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:johannhof@google.com">Johann Hofmann</a> (<a class="p-org org" href="https://google.com">Google</a>)
    </dl>
   </div>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="https://www.w3.org/policies/#copyright">Copyright</a> © 2025 the Contributors to the User Agent Interaction with Related Website Sets Specification, published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a> under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>.
A human-readable <a href="http://www.w3.org/community/about/agreements/cla-deed/">summary</a> is available. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>How user agents should integrate with Related Website Sets, a mechanism to declare a collection of related domains as being in a Related Website Set.</p>
  </div>
  <div data-fill-with="at-risk"></div>
  <h2 class="no-num no-toc no-ref heading settled" id="status"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p> This specification was published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a>.
  It is not a W3C Standard nor is it on the W3C Standards Track.

  Please note that under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a> there is a limited opt-out and other conditions apply.

  Learn more about <a href="http://www.w3.org/community/">W3C Community and Business Groups</a>. </p>
   <p></p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li><a href="#intro"><span class="secno">1</span> <span class="content">Introduction</span></a>
    <li><a href="#infra"><span class="secno">2</span> <span class="content">Infrastructure</span></a>
    <li><a href="#list-consumption"><span class="secno">3</span> <span class="content">List consumption</span></a>
    <li><a href="#data-structures"><span class="secno">4</span> <span class="content">Data Structures</span></a>
    <li><a href="#validating-inclusion"><span class="secno">5</span> <span class="content">Validating related website set inclusion</span></a>
    <li><a href="#storage-access-integration"><span class="secno">6</span> <span class="content">Integration with the Storage Access API</span></a>
    <li><a href="#handling-changes"><span class="secno">7</span> <span class="content">Handling related website set changes</span></a>
    <li><a href="#other-features"><span class="secno">8</span> <span class="content">Integration with other features</span></a>
    <li>
     <a href="#privacy-consideration"><span class="secno">9</span> <span class="content">Privacy Considerations</span></a>
     <ol class="toc">
      <li><a href="#provide-transparency"><span class="secno">9.1</span> <span class="content">Provide user transparency and control</span></a>
      <li><a href="#ensure-compatibility"><span class="secno">9.2</span> <span class="content">Ensure compatibility with non-RWS environments</span></a>
      <li><a href="#prevent-leaks"><span class="secno">9.3</span> <span class="content">Prevent privacy leaks from list changes</span></a>
     </ol>
    <li>
     <a href="#security-considerations"><span class="secno">10</span> <span class="content">Security Considerations</span></a>
     <ol class="toc">
      <li><a href="#avoid-weakening-boundaries"><span class="secno">10.1</span> <span class="content">Avoid weakening new and existing security boundaries</span></a>
     </ol>
    <li><a href="#acknowledgements"><span class="secno"></span> <span class="content">Acknowledgements</span></a>
    <li>
     <a href="#w3c-conformance"><span class="secno"></span> <span class="content">Conformance</span></a>
     <ol class="toc">
      <li><a href="#w3c-conventions"><span class="secno"></span> <span class="content">Document conventions</span></a>
     </ol>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
    <li><a href="#issues-index"><span class="secno"></span> <span class="content">Issues Index</span></a>
   </ol>
  </nav>
  <main>
   <h2 class="heading settled" data-level="1" id="intro"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#intro"></a></h2>
   <p><em>This section is non-normative.</em></p>
   <p>Related Website Sets (“RWS”) provides a framework for developers to declare relationships among sites, so that user agents can allow limited access to cross-site data, such as cookies, for user-facing purposes. This is facilitated through the use of the <a data-link-type="biblio" href="https://privacycg.github.io/storage-access/"><cite>Storage Access API</cite></a>.</p>
   <p>This document defines how user agents should integrate with the <a data-link-type="biblio" href="https://github.com/GoogleChrome/related-website-sets/blob/main/related_website_sets.JSON"><cite>Related Website Sets list</cite></a>. For a canonical reference of the structure of the RWS list and technical validations that are run at time of submission, please see the <a data-link-type="biblio" href="https://github.com/GoogleChrome/related-website-sets/blob/main/RWS-Submission_Guidelines.md"><cite>Related Website Sets Submission Guidelines</cite></a>.</p>
   <h2 class="heading settled" data-level="2" id="infra"><span class="secno">2. </span><span class="content">Infrastructure</span><a class="self-link" href="#infra"></a></h2>
   <p>This specification depends on the Infra standard. <a data-biblio-display="index" data-link-type="biblio" href="#biblio-infra" title="Infra Standard">[INFRA]</a></p>
   <h2 class="heading settled" data-level="3" id="list-consumption"><span class="secno">3. </span><span class="content">List consumption</span><a class="self-link" href="#list-consumption"></a></h2>
   <p>User agents should consume the canonical <a data-link-type="biblio" href="https://github.com/GoogleChrome/related-website-sets/blob/main/related_website_sets.JSON"><cite>Related Website Sets list</cite></a> on a regular basis (e.g., every 2 weeks) and ship it to individual clients (e.g. a browser application) as an updateable component.</p>
   <p class="issue" id="issue-2f53edbf"><a class="self-link" href="#issue-2f53edbf"></a> Can we make a recommendation for an update interval here? <a href="https://github.com/wicg/first-party-sets/issues/122">[wicg/first-party-sets Issue #122]</a></p>
   <p>Individual clients must <a data-link-type="dfn" href="#build-the-list-of-related-website-sets" id="ref-for-build-the-list-of-related-website-sets">build the list of related website sets</a> on restart, or on start-up, if newly downloaded. Clients must not re-build the list at any other point in time.</p>
   <p>The RWS list is a <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#utf-8" id="ref-for-utf-8">UTF-8</a> encoded file containing contents parseable as a JSON object, conforming to the <a data-biblio-display="index" data-link-type="biblio" href="#biblio-json-schema" title="JSON Schema: A Media Type for Describing JSON Documents">[JSON-SCHEMA]</a> described in the <a data-link-type="biblio" href="https://github.com/GoogleChrome/related-website-sets/blob/main/RWS-Submission_Guidelines.md"><cite>Related Website Sets Submission Guidelines</cite></a>.</p>
   <p class="note" role="note"><span class="marker">Note:</span> Conformance to the schema is validated at submission time. Hence, it is not required for the user agent to validate conformance again on the client. The algorithms in this specification describe how user agents should parse the RWS list, and when a particular set should be considered valid from the client’s perspective.</p>
   <p class="issue" id="issue-bb862ccb"><a class="self-link" href="#issue-bb862ccb"></a> Client-side validation may be needed in cases where the <a data-link-type="biblio" href="#biblio-psl"><cite>Public Suffix List</cite></a> version differs between the server and client. <a href="https://github.com/wicg/first-party-sets/issues/125">[wicg/first-party-sets Issue #125]</a></p>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="build-the-list-of-related-website-sets">build the list of related website sets</dfn> from a JSON <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#byte-sequence" id="ref-for-byte-sequence">byte sequence</a> <var>bytes</var>, the user agent should run the following steps:</p>
   <ol>
    <li data-md>
     <p>Let <var>json</var> be the result of <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#parse-json-bytes-to-an-infra-value" id="ref-for-parse-json-bytes-to-an-infra-value">parsing JSON bytes to an infra value</a> with <var>bytes</var>.</p>
    <li data-md>
     <p>If <var>json</var> is a parsing exception, or if <var>json</var> is not an <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#ordered-map" id="ref-for-ordered-map">ordered map</a>, or if <var>json</var>[“sets”] does not exist, return and optionally retry fetching the list, or perform other error recovery tasks.</p>
    <li data-md>
     <p>For each <var>entry</var> of <var>json</var>:</p>
     <ol>
      <li data-md>
       <p>Let <var>set</var> be a <a data-link-type="dfn" href="#related-website-set" id="ref-for-related-website-set">related website set</a>.</p>
      <li data-md>
       <p>If <var>entry</var>[“primary”] does not exist, continue.</p>
     </ol>
   </ol>
   <p class="issue" id="issue-f434ab32"><a class="self-link" href="#issue-f434ab32"></a> The specification currently suggests skipping invalid sets (missing primary entries) instead of rejecting the entire list. However, there may be benefit in a full rejection given that the server is expected to hold valid information at all times. <a href="https://github.com/wicg/first-party-sets/issues/126">[wicg/first-party-sets Issue #126]</a></p>
   <ol start="3">
    <li data-md>
     <p>Set <var>set</var>’s <a data-link-type="dfn" href="#related-website-set-primary" id="ref-for-related-website-set-primary">primary</a> to <var>entry</var>[“primary”].</p>
    <li data-md>
     <p>Let <var>ccTLDs</var> be the result of <a data-link-type="dfn" href="#parse-an-equivalence-map" id="ref-for-parse-an-equivalence-map">parsing an equivalence map</a> from <var>entry</var>[“ccTLDs”]. If <var>ccTLDs</var> is failure, continue.</p>
    <li data-md>
     <p>Set <var>set</var>’s ccTLDs to <var>ccTLDs</var>.</p>
    <li data-md>
     <p>Let <var>serviceSites</var> be the result of <a data-link-type="dfn" href="#parse-a-subset" id="ref-for-parse-a-subset">parsing a subset</a> from <var>entry</var>[“serviceSites”]. If the result is failure, continue.</p>
    <li data-md>
     <p>Set <var>set</var>’s <a data-link-type="dfn" href="#related-website-set-servicesites" id="ref-for-related-website-set-servicesites">serviceSites</a> to <var>serviceSites</var>.</p>
    <li data-md>
     <p>Let <var>associatedSites</var> be the result of <a data-link-type="dfn" href="#parse-a-subset" id="ref-for-parse-a-subset①">parsing a subset</a> from <var>entry</var>[“associatedSites”]. If the result is failure, continue.</p>
    <li data-md>
     <p>Set <var>set</var>’s <a data-link-type="dfn" href="#related-website-set-associatedsites" id="ref-for-related-website-set-associatedsites">associatedSites</a> to <var>associatedSites</var>.</p>
    <li data-md>
     <p>Add <var>set</var> to the user agent’s <a data-link-type="dfn" href="#list-of-related-website-sets" id="ref-for-list-of-related-website-sets">list of related website sets</a>.</p>
   </ol>
   <p>User agents may opt to pre-process the list into a different format before delivery to the client, e.g. for optimization reasons, as long as they ensure that the client will eventually hold a valid <a data-link-type="dfn" href="#list-of-related-website-sets" id="ref-for-list-of-related-website-sets①">list of related website sets</a> as defined in this specification.</p>
   <h2 class="heading settled" data-level="4" id="data-structures"><span class="secno">4. </span><span class="content">Data Structures</span><a class="self-link" href="#data-structures"></a></h2>
   <p>The user agent maintains a global <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="list-of-related-website-sets">list of related website sets</dfn>, which is a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list">list</a> of <a data-link-type="dfn" href="#related-website-set" id="ref-for-related-website-set①">related website sets</a>.</p>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="related-website-set">related website set</dfn> is a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#struct" id="ref-for-struct">struct</a> with the following items:</p>
   <p><dfn class="dfn-paneled" data-dfn-for="related website set" data-dfn-type="dfn" data-noexport id="related-website-set-primary">primary</dfn>: A <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site">site</a> that represents the set’s primary domain.</p>
   <p><dfn class="dfn-paneled" data-dfn-for="related website set" data-dfn-type="dfn" data-noexport id="related-website-set-cctlds">ccTLDs</dfn>: An <a data-link-type="dfn" href="#equivalence-map" id="ref-for-equivalence-map">equivalence map</a>, representing the set’s equivalent country-code top level domains that were specified by the submitter.</p>
   <p><dfn class="dfn-paneled" data-dfn-for="related website set" data-dfn-type="dfn" data-noexport id="related-website-set-associatedsites">associatedSites</dfn>: A <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list①">list</a> of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site①">sites</a> in the associated subset.</p>
   <p><dfn class="dfn-paneled" data-dfn-for="related website set" data-dfn-type="dfn" data-noexport id="related-website-set-servicesites">serviceSites</dfn>: A <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list②">list</a> of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site②">sites</a> in the service subset.</p>
   <p class="note" role="note"><span class="marker">Note:</span> For additional context on the meaning of these fields please refer to the <a data-link-type="biblio" href="https://github.com/GoogleChrome/related-website-sets/blob/main/RWS-Submission_Guidelines.md"><cite>Related Website Sets Submission Guidelines</cite></a>.</p>
   <p>An <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="equivalence-map">equivalence map</dfn> is an <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#ordered-map" id="ref-for-ordered-map①">ordered map</a> from <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site③">sites</a> to <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list③">lists</a> of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site④">sites</a>.</p>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="parse-and-validate-a-site">parse and validate a site</dfn> from a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#string" id="ref-for-string">string</a> <var>input</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>Let <var>url</var> be the result of <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-basic-url-parser" id="ref-for-concept-basic-url-parser">basic URL parsing</a> <var>input</var>. If the result is failure, return failure.</p>
    <li data-md>
     <p>If <var>url</var>’s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-scheme" id="ref-for-concept-url-scheme">scheme</a> is not "<code>https</code>", return failure.</p>
    <li data-md>
     <p>Let <var>site</var> be the result of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site" id="ref-for-obtain-a-site">obtaining a site</a> from <var>url</var>’s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-origin" id="ref-for-concept-url-origin">origin</a>.</p>
    <li data-md>
     <p>Return <var>site</var>.</p>
   </ol>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="parse-a-subset">parse a subset</dfn> from a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list④">list</a> <var>input</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>Let <var>list</var> be an empty <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list⑤">list</a>.</p>
    <li data-md>
     <p>For each <var>item</var> of <var>input</var>:</p>
     <ol>
      <li data-md>
       <p>Let <var>site</var> be the result of <a data-link-type="dfn" href="#parse-and-validate-a-site" id="ref-for-parse-and-validate-a-site">parsing and validating a site</a> from <var>item</var>.</p>
      <li data-md>
       <p>If <var>site</var> is failure, return failure.</p>
      <li data-md>
       <p>Add <var>site</var> to <var>list</var>.</p>
     </ol>
    <li data-md>
     <p>Return <var>list</var>.</p>
   </ol>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="parse-an-equivalence-map">parse an equivalence map</dfn> from an ordered map <var>input</var>, run the following steps:</p>
   <ol start="4">
    <li data-md>
     <p>Let <var>map</var> be an empty <a data-link-type="dfn" href="#equivalence-map" id="ref-for-equivalence-map①">equivalence map</a>.</p>
    <li data-md>
     <p>For each <var>key</var> → <var>value</var> of <var>input</var>:</p>
     <ol start="4">
      <li data-md>
       <p>Let <var>keySite</var> be the result of <a data-link-type="dfn" href="#parse-and-validate-a-site" id="ref-for-parse-and-validate-a-site①">parsing and validating a site</a> from <var>key</var>. If the result is failure, return failure.</p>
      <li data-md>
       <p>Let <var>equivalents</var> be an empty list.</p>
      <li data-md>
       <p>For each <var>equivalent</var> in <var>value</var>:</p>
       <ol>
        <li data-md>
         <p>Let <var>equivalentSite</var> be the result of <a data-link-type="dfn" href="#parse-and-validate-a-site" id="ref-for-parse-and-validate-a-site②">parsing and validating a site</a> from <var>equivalent</var>. If the result is failure, return failure.</p>
        <li data-md>
         <p>Add <var>equivalentSite</var> to <var>equivalents</var>.</p>
       </ol>
      <li data-md>
       <p>Set <var>map</var>[<var>keySite</var>] to <var>equivalents</var>.</p>
     </ol>
    <li data-md>
     <p>Return <var>map</var>.</p>
   </ol>
   <h2 class="heading settled" data-level="5" id="validating-inclusion"><span class="secno">5. </span><span class="content">Validating related website set inclusion</span><a class="self-link" href="#validating-inclusion"></a></h2>
   <p>Under RWS, a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site⑤">site</a> <var>site1</var> is considered <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="equivalent-to">equivalent to</dfn> another <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site⑥">site</a> <var>site2</var> given an <a data-link-type="dfn" href="#equivalence-map" id="ref-for-equivalence-map②">equivalence map</a> <var>equivalents</var>, if <var>equivalents</var>[<var>site1</var>] contains <var>site2</var> or <var>equivalents</var>[<var>site2</var>] contains <var>site1</var>.</p>
   <p class="issue" id="issue-7a693f54"><a class="self-link" href="#issue-7a693f54"></a> Should this be renamed to avoid being confused with a mathematical equivalence relation? <a href="https://github.com/wicg/first-party-sets/issues/123">[wicg/first-party-sets Issue #123]</a></p>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="determine-the-member-type">determine the member type</dfn> of a given <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site⑦">site</a> <var>site</var> in a given <a data-link-type="dfn" href="#related-website-set" id="ref-for-related-website-set②">related website set</a> <var>set</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>If <var>site</var> is <a data-link-type="dfn" href="#equivalent-to" id="ref-for-equivalent-to">equivalent to</a> <var>set</var>’s <a data-link-type="dfn" href="#related-website-set-primary" id="ref-for-related-website-set-primary①">primary</a> given <var>set</var>’s <a data-link-type="dfn" href="#related-website-set-cctlds" id="ref-for-related-website-set-cctlds">ccTLDs</a>, return “primary”.</p>
    <li data-md>
     <p>For each <var>associatedSite</var> of <var>set</var>’s <a data-link-type="dfn" href="#related-website-set-associatedsites" id="ref-for-related-website-set-associatedsites①">associatedSites</a>:</p>
     <ol>
      <li data-md>
       <p>If <var>site</var> is <a data-link-type="dfn" href="#equivalent-to" id="ref-for-equivalent-to①">equivalent to</a> <var>associatedSite</var> given <var>set</var>’s <a data-link-type="dfn" href="#related-website-set-cctlds" id="ref-for-related-website-set-cctlds①">ccTLDs</a>, return “associated”.</p>
     </ol>
    <li data-md>
     <p>For each <var>serviceSite</var> of <var>set</var>’s <a data-link-type="dfn" href="#related-website-set-servicesites" id="ref-for-related-website-set-servicesites①">serviceSites</a>:</p>
     <ol start="2">
      <li data-md>
       <p>If <var>site</var> is <a data-link-type="dfn" href="#equivalent-to" id="ref-for-equivalent-to②">equivalent to</a> <var>serviceSite</var> given <var>set</var>’s <a data-link-type="dfn" href="#related-website-set-cctlds" id="ref-for-related-website-set-cctlds②">ccTLDs</a>, return “service”.</p>
     </ol>
    <li data-md>
     <p>Return “none”.</p>
   </ol>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="find-a-related-website-set">find a related website set</dfn> for a given <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site⑧">site</a> <var>site</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>For each <var>set</var> of the user agent’s <a data-link-type="dfn" href="#list-of-related-website-sets" id="ref-for-list-of-related-website-sets②">list of related website sets</a>:</p>
     <ol>
      <li data-md>
       <p>Let <var>type</var> be the <a data-link-type="dfn" href="#determine-the-member-type" id="ref-for-determine-the-member-type">member type</a> of <var>site</var> in <var>set</var>.</p>
      <li data-md>
       <p>If <var>type</var> is not “none”, return <var>set</var>.</p>
     </ol>
    <li data-md>
     <p>Return null.</p>
   </ol>
   <p class="note" role="note"><span class="marker">Note:</span> The <a data-link-type="biblio" href="https://github.com/GoogleChrome/related-website-sets/blob/main/RWS-Submission_Guidelines.md"><cite>Related Website Sets Submission Guidelines</cite></a> require that each site can only appear in at most one Related Website set, which is validated at submission time. For this reason, user agents do not need to be concerned with the order of the list of related website sets when performing these steps.</p>
   <p>Define the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="limit-for-associated-sites">limit for associated sites</dfn> within a single <a data-link-type="dfn" href="#related-website-set" id="ref-for-related-website-set③">related website set</a> to be an <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined">implementation-defined</a> value, which is recommended to be 3.</p>
   <p class="note" role="note"><span class="marker">Note:</span> This limit is used when <a data-link-type="dfn" href="#determine-eligibility-for-an-associated-site" id="ref-for-determine-eligibility-for-an-associated-site">determining eligibility for an associated site</a> to only consider the sites listed at the top of the associated subset. It is meant to discourage abuse and help users and user agents understand why a particular related website set needs to exist. User agents may choose a different number based on this goal.</p>
   <p>A <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site⑨">site</a> <var>embeddedSite</var> is <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="eligible-for-same-party-membership-when-embedded-within">eligible for same-party membership when embedded within</dfn> a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site①⓪">site</a> <var>topLevelSite</var>, if the following steps return true:</p>
   <ol>
    <li data-md>
     <p>Let <var>set</var> be the result of <a data-link-type="dfn" href="#find-a-related-website-set" id="ref-for-find-a-related-website-set">finding a related website set</a> for <var>topLevelSite</var>.</p>
    <li data-md>
     <p>If <var>set</var> is null, return false.</p>
    <li data-md>
     <p>Let <var>topLevelType</var> be the <a data-link-type="dfn" href="#determine-the-member-type" id="ref-for-determine-the-member-type①">member type</a> of <var>topLevelSite</var> in <var>set</var>.</p>
    <li data-md>
     <p>If <var>topLevelType</var> is “associated” and the result of <a data-link-type="dfn" href="#determine-eligibility-for-an-associated-site" id="ref-for-determine-eligibility-for-an-associated-site①">determining eligibility for an associated site</a> given <var>topLevelSite</var> and <var>set</var> is false, return false.</p>
    <li data-md>
     <p>If <var>topLevelType</var> is “service”, return false.</p>
    <li data-md>
     <p>Let <var>type</var> be the <a data-link-type="dfn" href="#determine-the-member-type" id="ref-for-determine-the-member-type②">member type</a> of <var>embeddedSite</var> in <var>set</var>.</p>
    <li data-md>
     <p>If <var>type</var> is “none”, return false.</p>
    <li data-md>
     <p>If <var>type</var> is “associated”, return the result of <a data-link-type="dfn" href="#determine-eligibility-for-an-associated-site" id="ref-for-determine-eligibility-for-an-associated-site②">determining eligibility for an associated site</a> given <var>embeddedSite</var> and <var>set</var>.</p>
    <li data-md>
     <p>Return true.</p>
   </ol>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="determine-eligibility-for-an-associated-site">determine eligibility for an associated site</dfn> given a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site①①">site</a> <var>site</var> and a <a data-link-type="dfn" href="#related-website-set" id="ref-for-related-website-set④">related website set</a> <var>set</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>If <var>set</var>’s <a data-link-type="dfn" href="#related-website-set-associatedsites" id="ref-for-related-website-set-associatedsites②">associatedSites</a> does not contain <var>site</var>, return false.</p>
    <li data-md>
     <p>Let <var>index</var> be the index of <var>site</var> in <var>set</var>’s <a data-link-type="dfn" href="#related-website-set-associatedsites" id="ref-for-related-website-set-associatedsites③">associatedSites</a>.</p>
    <li data-md>
     <p>If <var>index</var> is greater than or equal to the <a data-link-type="dfn" href="#limit-for-associated-sites" id="ref-for-limit-for-associated-sites">limit for associated sites</a>, return false.</p>
    <li data-md>
     <p>Return true.</p>
   </ol>
   <p>A given <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object" id="ref-for-environment-settings-object">environment settings object</a> <var>settings</var> <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="is-same-party-with-its-top-level-embedder">is same-party with its top-level embedder</dfn>, if the following steps return true:</p>
   <ol>
    <li data-md>
     <p>Let <var>topLevelSite</var> be the result of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site" id="ref-for-obtain-a-site①">obtaining a site</a> from <var>settings</var>’ <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin" id="ref-for-concept-environment-top-level-origin">top-level origin</a>.</p>
    <li data-md>
     <p>Let <var>embeddedSite</var> be the result of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site" id="ref-for-obtain-a-site②">obtaining a site</a> from <var>settings</var>’ <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin" id="ref-for-concept-settings-object-origin">origin</a>.</p>
    <li data-md>
     <p>Return whether <var>embeddedSite</var> is <a data-link-type="dfn" href="#eligible-for-same-party-membership-when-embedded-within" id="ref-for-eligible-for-same-party-membership-when-embedded-within">eligible for same-party membership when embedded within</a> <var>topLevelSite</var>.</p>
   </ol>
   <p>A given <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object" id="ref-for-environment-settings-object①">environment settings object</a> <var>settings</var> and <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin">origin</a> <var>origin</var> <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="are-same-party-in-an-embedding-context">are same-party in an embedding context</dfn>, if the following steps return true:</p>
   <ol>
    <li data-md>
     <p>Let <var>topLevelSite</var> be the result of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site" id="ref-for-obtain-a-site③">obtaining a site</a> from <var>settings</var>’ <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin" id="ref-for-concept-environment-top-level-origin①">top-level origin</a>.</p>
    <li data-md>
     <p>Let <var>embeddedSite</var> be the result of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site" id="ref-for-obtain-a-site④">obtaining a site</a> from <var>origin</var>.</p>
    <li data-md>
     <p>Return whether <var>embeddedSite</var> is <a data-link-type="dfn" href="#eligible-for-same-party-membership-when-embedded-within" id="ref-for-eligible-for-same-party-membership-when-embedded-within①">eligible for same-party membership when embedded within</a> <var>topLevelSite</var>.</p>
   </ol>
   <h2 class="heading settled" data-level="6" id="storage-access-integration"><span class="secno">6. </span><span class="content">Integration with the Storage Access API</span><a class="self-link" href="#storage-access-integration"></a></h2>
   <p>Modify <code class="idl"><a data-link-type="idl" href="https://privacycg.github.io/storage-access/#dom-document-requeststorageaccess" id="ref-for-dom-document-requeststorageaccess">requestStorageAccess()</a></code> to insert the following steps before step 13.5 (i.e. before <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-request-permission-to-use" id="ref-for-dfn-request-permission-to-use">requesting permission to use</a>):</p>
   <ol>
    <li data-md>
     <p>Let <var>settings</var> be <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object" id="ref-for-relevant-settings-object">relevant settings object</a>.</p>
    <li data-md>
     <p>If <var>settings</var> <a data-link-type="dfn" href="#is-same-party-with-its-top-level-embedder" id="ref-for-is-same-party-with-its-top-level-embedder">is same-party with its top-level embedder</a>, the user agent may run <var>process permission state</var> with <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-granted" id="ref-for-dfn-granted">granted</a> and abort the remaining steps.</p>
   </ol>
   <p>Modify <code class="idl"><a data-link-type="idl" href="https://privacycg.github.io/requestStorageAccessFor/#dom-document-requeststorageaccessfor" id="ref-for-dom-document-requeststorageaccessfor">requestStorageAccessFor(requestedOrigin)</a></code> to insert the following steps before step 13.8 (i.e. before <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-request-permission-to-use" id="ref-for-dfn-request-permission-to-use①">requesting permission to use</a>):</p>
   <ol>
    <li data-md>
     <p>Let <var>settings</var> be <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object" id="ref-for-relevant-settings-object①">relevant settings object</a>.</p>
    <li data-md>
     <p>If <var>settings</var> and <var>requestedOrigin</var> <a data-link-type="dfn" href="#are-same-party-in-an-embedding-context" id="ref-for-are-same-party-in-an-embedding-context">are same-party in an embedding context</a>, the user agent may <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task" id="ref-for-queue-a-global-task">queue a global task</a> on the <a data-link-type="dfn" href="https://w3c.github.io/permissions/#permissions-task-source" id="ref-for-permissions-task-source">permissions task source</a> given <var>global</var> to <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve">resolve</a> <var>p</var> and abort the remaining steps.</p>
   </ol>
   <h2 class="heading settled" data-level="7" id="handling-changes"><span class="secno">7. </span><span class="content">Handling related website set changes</span><a class="self-link" href="#handling-changes"></a></h2>
   <p>When a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site①②">site</a> <var>site</var> leaves a <a data-link-type="dfn" href="#related-website-set" id="ref-for-related-website-set⑤">related website set</a> as the result of building a new <a data-link-type="dfn" href="#list-of-related-website-sets" id="ref-for-list-of-related-website-sets③">list of related website sets</a>, user agents must ensure that it does not retain any access to data or shared identifiers held by other sites in the related website set by running the following steps:</p>
   <ol>
    <li data-md>
     <p>Assert that <var>site</var> is not an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque" id="ref-for-concept-origin-opaque">opaque origin</a>.</p>
    <li data-md>
     <p>Let <var>domain</var> be site’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-host" id="ref-for-concept-origin-host">host</a>.</p>
    <li data-md>
     <p>For each <var>origin</var> known to the user agent whose <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-host" id="ref-for-concept-origin-host①">host</a>’s <a data-link-type="dfn" href="https://publicsuffix.org/list/#" id="ref-for-something">registered domain</a> is <var>domain</var>:</p>
     <ol>
      <li data-md>
       <p><a data-link-type="dfn" href="https://www.w3.org/TR/clear-site-data/#abstract-opdef-clear-cache-for-origin" id="ref-for-abstract-opdef-clear-cache-for-origin">Clear cache for origin</a>.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="https://www.w3.org/TR/clear-site-data/#abstract-opdef-clear-cookies-for-origin" id="ref-for-abstract-opdef-clear-cookies-for-origin">Clear cookies for origin</a>.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="https://www.w3.org/TR/clear-site-data/#abstract-opdef-clear-dom-accessible-storage-for-origin" id="ref-for-abstract-opdef-clear-dom-accessible-storage-for-origin">Clear DOM-accessible storage for origin</a>.</p>
      <li data-md>
       <p>Let <var>descriptor</var> be a newly-created <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/permissions/#dom-permissiondescriptor" id="ref-for-dom-permissiondescriptor">PermissionDescriptor</a></code> with <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/permissions/#dom-permissiondescriptor-name" id="ref-for-dom-permissiondescriptor-name">name</a></code> initialized to “storage-access”.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-remove-a-permission-store-entry" id="ref-for-dfn-remove-a-permission-store-entry">Remove all permission store entries</a> for <var>descriptor</var>, where key[0] is <var>site</var> or key[1] is <var>origin</var>.</p>
      <li data-md>
       <p>Run additional <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined①">implementation-defined</a> steps to ensure that any web-accessible storage is removed from <var>origin</var>.</p>
     </ol>
   </ol>
   <p class="issue" id="issue-a87490bb"><a class="self-link" href="#issue-a87490bb"></a> This section should provide more details on how user agents can figure out when a site leaves an RWS. <a href="https://github.com/wicg/first-party-sets/issues/124">[wicg/first-party-sets Issue #124]</a></p>
   <h2 class="heading settled" data-level="8" id="other-features"><span class="secno">8. </span><span class="content">Integration with other features</span><a class="self-link" href="#other-features"></a></h2>
   <p>User agents may use the domain relationships declared through RWS for other implementation-defined purposes, in which case they must still follow the rest of this specification for consuming and storing the RWS list as well as checking eligibility for same-party membership.</p>
   <p class="note" role="note"><span class="marker">Note:</span> For example, <a href="https://github.com/GoogleChrome/ip-protection">Chrome’s IP Protection proposal</a> includes relying on RWS for the purposes of determining first-party and third-party contexts.</p>
   <h2 class="heading settled" data-level="9" id="privacy-consideration"><span class="secno">9. </span><span class="content">Privacy Considerations</span><a class="self-link" href="#privacy-consideration"></a></h2>
   <h3 class="heading settled" data-level="9.1" id="provide-transparency"><span class="secno">9.1. </span><span class="content">Provide user transparency and control</span><a class="self-link" href="#provide-transparency"></a></h3>
   <p>A user agent that uses RWS to infer the relationship between two sites should ensure that its users are informed about this user agent choice and give users the opportunity to view and control choices made by the user agent.</p>
   <h3 class="heading settled" data-level="9.2" id="ensure-compatibility"><span class="secno">9.2. </span><span class="content">Ensure compatibility with non-RWS environments</span><a class="self-link" href="#ensure-compatibility"></a></h3>
   <p>Some user agents may choose not to support RWS in specific environments (such as Private Browsing Modes), or at all. All user agents and specifications should be mindful of this in their own API integrations and aim to gracefully fall back to a working solution for users and developers.</p>
   <p>For providing access to cross-site cookies, this specification aims to ensure compatibility with non-RWS environments through usage of the <a data-link-type="biblio" href="https://privacycg.github.io/storage-access/"><cite>Storage Access API</cite></a>, which provides developers an interface to handle rejections to the request and gives user agents flexibility to employ mechanisms such as prompts or heuristics as an alternative to RWS.</p>
   <h3 class="heading settled" data-level="9.3" id="prevent-leaks"><span class="secno">9.3. </span><span class="content">Prevent privacy leaks from list changes</span><a class="self-link" href="#prevent-leaks"></a></h3>
   <p>Developers may submit changes to their sets to add or remove sites. Since membership in a set could provide access to cross-site cookies via automatic grants of the <a data-link-type="biblio" href="https://privacycg.github.io/storage-access/"><cite>Storage Access API</cite></a>, we need to pay attention to these transitions so that they don’t link user identities across all the RWSs they’ve historically been in. In particular, we must ensure that a domain cannot transfer a user identifier from one Related Website Set to another when it changes its set membership. While a set member may not always request and be granted access to cross-site cookies, for the sake of simplicity of handling set transitions, we propose to treat such access as always granted.</p>
   <p>For this reason, this specification requires user agents to clear any site data and storage-access permissions of a given site when a site is removed from a set, before starting any fetches that rely on those permissions or site data.</p>
   <p class="note" role="note"><span class="marker">Note:</span> Most fetches do not depend on data that needs to be cleared, so user agents are advised to optimize for request latency.</p>
   <h2 class="heading settled" data-level="10" id="security-considerations"><span class="secno">10. </span><span class="content">Security Considerations</span><a class="self-link" href="#security-considerations"></a></h2>
   <h3 class="heading settled" data-level="10.1" id="avoid-weakening-boundaries"><span class="secno">10.1. </span><span class="content">Avoid weakening new and existing security boundaries</span><a class="self-link" href="#avoid-weakening-boundaries"></a></h3>
   <p>Changes to the web platform that tighten boundaries for increased privacy often have positive effects on security as well. For example, cache partitioning restricts <a data-link-type="biblio" href="https://xsleaks.dev/docs/attacks/cache-probing/"><cite>Cache Probing</cite></a> attacks and third-party cookie blocking makes it much harder to perform <a data-link-type="biblio" href="https://owasp.org/www-community/attacks/csrf"><cite>Cross Site Request Forgery (CSRF)</cite></a> by default. Where user agents intend to use Related Website Sets to replace or extend existing boundaries based on site or origin on the web, it is important to consider not only the effects on privacy, but also on security.</p>
   <p>Sites in a common RWS may have greatly varying security requirements, for example, a set could contain a site storing user credentials and another hosting untrusted user data. Even within the same set, sites still rely on cross-site and cross-origin restrictions to stay in control of data exposure. Within reason, it should not be possible for a compromised site in an RWS to affect the integrity of other sites in the set.</p>
   <p>This consideration will always involve a necessary trade-off between gains like performance or interoperability and risks for users and sites. User agents should facilitate additional mechanisms such as a per-origin opt-in or opt-out to manage this trade-off.</p>
   <h2 class="no-num heading settled" id="acknowledgements"><span class="content">Acknowledgements</span><a class="self-link" href="#acknowledgements"></a></h2>
   <p>Other members of the W3C Privacy Community Group had previously suggested the use of Storage Access API, or an equivalent API; in place of SameParty cookies. Thanks to @jdcauley (<a href="https://github.com/WICG/first-party-sets/issues/14#issuecomment-785144990">1</a>), @arthuredelstein (<a href="https://github.com/WICG/first-party-sets/issues/42">2</a>), and @johnwilander (<a href="https://lists.w3.org/Archives/Public/public-privacycg/2022Jun/0001.html">3</a>).</p>
   <p>Browser vendors, web developers, and members of the web community provided valuable feedback during this proposal’s incubation in the W3C Privacy Community Group.</p>
   <p>This proposal includes significant contributions from previous co-editors, David Benjamin, and Harneet Sidhana.</p>
   <p>We are also grateful for contributions from Chris Fredrickson and Shuran Huang.</p>
  </main>
  <div data-fill-with="conformance">
   <h2 class="no-ref no-num heading settled" id="w3c-conformance"><span class="content">Conformance</span><a class="self-link" href="#w3c-conformance"></a></h2>
   <h3 class="no-ref no-num heading settled" id="w3c-conventions"><span class="content">Document conventions</span><a class="self-link" href="#w3c-conventions"></a></h3>
   <p>Conformance requirements are expressed
    with a combination of descriptive assertions
    and RFC 2119 terminology.
    The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL”
    in the normative parts of this document
    are to be interpreted as described in RFC 2119.
    However, for readability,
    these words do not appear in all uppercase letters in this specification. </p>
   <p>All of the text of this specification is normative
    except sections explicitly marked as non-normative, examples, and notes. <a data-link-type="biblio" href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a> </p>
   <p>Examples in this specification are introduced with the words “for example”
    or are set apart from the normative text
    with <code>class="example"</code>,
    like this: </p>
   <div class="example" id="w3c-example">
    <a class="self-link" href="#w3c-example"></a> 
    <p>This is an example of an informative example. </p>
   </div>
   <p>Informative notes begin with the word “Note”
    and are set apart from the normative text
    with <code>class="note"</code>,
    like this: </p>
   <p class="note" role="note">Note, this is an informative note.</p>
  </div>
  <script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#are-same-party-in-an-embedding-context">are same-party in an embedding context</a><span>, in § 5</span>
   <li><a href="#related-website-set-associatedsites">associatedSites</a><span>, in § 4</span>
   <li><a href="#build-the-list-of-related-website-sets">build the list of related website sets</a><span>, in § 3</span>
   <li><a href="#related-website-set-cctlds">ccTLDs</a><span>, in § 4</span>
   <li><a href="#determine-eligibility-for-an-associated-site">determine eligibility for an associated site</a><span>, in § 5</span>
   <li><a href="#determine-the-member-type">determine the member type</a><span>, in § 5</span>
   <li><a href="#eligible-for-same-party-membership-when-embedded-within">eligible for same-party membership when embedded within</a><span>, in § 5</span>
   <li><a href="#equivalence-map">equivalence map</a><span>, in § 4</span>
   <li><a href="#equivalent-to">equivalent to</a><span>, in § 5</span>
   <li><a href="#find-a-related-website-set">find a related website set</a><span>, in § 5</span>
   <li><a href="#is-same-party-with-its-top-level-embedder">is same-party with its top-level embedder</a><span>, in § 5</span>
   <li><a href="#limit-for-associated-sites">limit for associated sites</a><span>, in § 5</span>
   <li><a href="#list-of-related-website-sets">list of related website sets</a><span>, in § 4</span>
   <li><a href="#parse-and-validate-a-site">parse and validate a site</a><span>, in § 4</span>
   <li><a href="#parse-an-equivalence-map">parse an equivalence map</a><span>, in § 4</span>
   <li><a href="#parse-a-subset">parse a subset</a><span>, in § 4</span>
   <li><a href="#related-website-set-primary">primary</a><span>, in § 4</span>
   <li><a href="#related-website-set">related website set</a><span>, in § 4</span>
   <li><a href="#related-website-set-servicesites">serviceSites</a><span>, in § 4</span>
  </ul>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[CLEAR-SITE-DATA]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="9b4f1943">clear cache for origin</span>
     <li><span class="dfn-paneled" id="0fda77ac">clear cookies for origin</span>
     <li><span class="dfn-paneled" id="a0459604">clear dom-accessible storage for origin</span>
    </ul>
   <li>
    <a data-link-type="biblio">[ENCODING]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="bffb633e">UTF-8</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HTML]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="3e12e042">environment settings object</span>
     <li><span class="dfn-paneled" id="77a2ee6e">host</span>
     <li><span class="dfn-paneled" id="602b1a68">obtain a site</span>
     <li><span class="dfn-paneled" id="b01b1359">opaque origin</span>
     <li><span class="dfn-paneled" id="086e3aff">origin</span>
     <li><span class="dfn-paneled" id="43ac8374">origin <small>(for environment settings object)</small></span>
     <li><span class="dfn-paneled" id="48438eb3">queue a global task</span>
     <li><span class="dfn-paneled" id="9c4c1e66">relevant settings object</span>
     <li><span class="dfn-paneled" id="fb9bb722">site</span>
     <li><span class="dfn-paneled" id="c63519ed">top-level origin</span>
    </ul>
   <li>
    <a data-link-type="biblio">[INFRA]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="3de9e659">byte sequence</span>
     <li><span class="dfn-paneled" id="860300d4">implementation-defined</span>
     <li><span class="dfn-paneled" id="649608b9">list</span>
     <li><span class="dfn-paneled" id="84b454ff">ordered map</span>
     <li><span class="dfn-paneled" id="0a78af08">parse JSON bytes to an Infra value</span>
     <li><span class="dfn-paneled" id="0698d556">string</span>
     <li><span class="dfn-paneled" id="984221ca">struct</span>
    </ul>
   <li>
    <a data-link-type="biblio">[PERMISSIONS]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="ebb01253">PermissionDescriptor</span>
     <li><span class="dfn-paneled" id="6821ab89">granted</span>
     <li><span class="dfn-paneled" id="0310eecd">name</span>
     <li><span class="dfn-paneled" id="03af1875">permissions task source</span>
     <li><span class="dfn-paneled" id="56736c6d">remove a permission store entry</span>
     <li><span class="dfn-paneled" id="d357c753">requesting permission to use</span>
    </ul>
   <li>
    <a data-link-type="biblio">[PSL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="aba5485c">registered domain</span>
    </ul>
   <li>
    <a data-link-type="biblio">[REQUESTSTORAGEACCESSFOR]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="09ba3f74">requestStorageAccessFor(requestedOrigin)</span>
    </ul>
   <li>
    <a data-link-type="biblio">[STORAGE-ACCESS]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="aa7820f7">requestStorageAccess()</span>
    </ul>
   <li>
    <a data-link-type="biblio">[URL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="9ed8b710">basic URL parser</span>
     <li><span class="dfn-paneled" id="959ad97b">origin</span>
     <li><span class="dfn-paneled" id="3a711be7">scheme</span>
    </ul>
   <li>
    <a data-link-type="biblio">[WEBIDL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="3b90bdcd">resolve</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-clear-site-data">[CLEAR-SITE-DATA]
   <dd>Mike West. <a href="https://w3c.github.io/webappsec-clear-site-data/"><cite>Clear Site Data</cite></a>. URL: <a href="https://w3c.github.io/webappsec-clear-site-data/">https://w3c.github.io/webappsec-clear-site-data/</a>
   <dt id="biblio-encoding">[ENCODING]
   <dd>Anne van Kesteren. <a href="https://encoding.spec.whatwg.org/"><cite>Encoding Standard</cite></a>. Living Standard. URL: <a href="https://encoding.spec.whatwg.org/">https://encoding.spec.whatwg.org/</a>
   <dt id="biblio-html">[HTML]
   <dd>Anne van Kesteren; et al. <a href="https://html.spec.whatwg.org/multipage/"><cite>HTML Standard</cite></a>. Living Standard. URL: <a href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
   <dt id="biblio-infra">[INFRA]
   <dd>Anne van Kesteren; Domenic Denicola. <a href="https://infra.spec.whatwg.org/"><cite>Infra Standard</cite></a>. Living Standard. URL: <a href="https://infra.spec.whatwg.org/">https://infra.spec.whatwg.org/</a>
   <dt id="biblio-permissions">[PERMISSIONS]
   <dd>Marcos Caceres; Mike Taylor. <a href="https://w3c.github.io/permissions/"><cite>Permissions</cite></a>. URL: <a href="https://w3c.github.io/permissions/">https://w3c.github.io/permissions/</a>
   <dt id="biblio-psl">[PSL]
   <dd><cite><a href="https://publicsuffix.org/">Public Suffix List</a></cite>.    Mozilla Foundation.
   <dt id="biblio-requeststorageaccessfor">[REQUESTSTORAGEACCESSFOR]
   <dd><a href="https://privacycg.github.io/requestStorageAccessFor/"><cite>requestStorageAccessFor API</cite></a>. Editor's Draft. URL: <a href="https://privacycg.github.io/requestStorageAccessFor/">https://privacycg.github.io/requestStorageAccessFor/</a>
   <dt id="biblio-rfc2119">[RFC2119]
   <dd>S. Bradner. <a href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. March 1997. Best Current Practice. URL: <a href="https://datatracker.ietf.org/doc/html/rfc2119">https://datatracker.ietf.org/doc/html/rfc2119</a>
   <dt id="biblio-storage-access">[STORAGE-ACCESS]
   <dd><a href="https://privacycg.github.io/storage-access/"><cite>Storage Access API</cite></a>. CG Draft. URL: <a href="https://privacycg.github.io/storage-access/">https://privacycg.github.io/storage-access/</a>
   <dt id="biblio-url">[URL]
   <dd>Anne van Kesteren. <a href="https://url.spec.whatwg.org/"><cite>URL Standard</cite></a>. Living Standard. URL: <a href="https://url.spec.whatwg.org/">https://url.spec.whatwg.org/</a>
   <dt id="biblio-webidl">[WEBIDL]
   <dd>Edgar Chen; Timothy Gu. <a href="https://webidl.spec.whatwg.org/"><cite>Web IDL Standard</cite></a>. Living Standard. URL: <a href="https://webidl.spec.whatwg.org/">https://webidl.spec.whatwg.org/</a>
  </dl>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-cache-probing">[CACHE-PROBING]
   <dd><a href="https://xsleaks.dev/docs/attacks/cache-probing/"><cite>Cache Probing</cite></a>. URL: <a href="https://xsleaks.dev/docs/attacks/cache-probing/">https://xsleaks.dev/docs/attacks/cache-probing/</a>
   <dt id="biblio-csrf">[CSRF]
   <dd><a href="https://owasp.org/www-community/attacks/csrf"><cite>Cross Site Request Forgery (CSRF)</cite></a>. URL: <a href="https://owasp.org/www-community/attacks/csrf">https://owasp.org/www-community/attacks/csrf</a>
   <dt id="biblio-json-schema">[JSON-SCHEMA]
   <dd>Austin Wright; et al. <a href="https://datatracker.ietf.org/doc/html/draft-bhutton-json-schema"><cite>JSON Schema: A Media Type for Describing JSON Documents</cite></a>. 10 June 2022. Internet-Draft. URL: <a href="https://datatracker.ietf.org/doc/html/draft-bhutton-json-schema">https://datatracker.ietf.org/doc/html/draft-bhutton-json-schema</a>
   <dt id="biblio-rws-list">[RWS-LIST]
   <dd><a href="https://github.com/GoogleChrome/related-website-sets/blob/main/related_website_sets.JSON"><cite>Related Website Sets list</cite></a>. URL: <a href="https://github.com/GoogleChrome/related-website-sets/blob/main/related_website_sets.JSON">https://github.com/GoogleChrome/related-website-sets/blob/main/related_website_sets.JSON</a>
   <dt id="biblio-submission-guidelines">[SUBMISSION-GUIDELINES]
   <dd><a href="https://github.com/GoogleChrome/related-website-sets/blob/main/RWS-Submission_Guidelines.md"><cite>Related Website Sets Submission Guidelines</cite></a>. URL: <a href="https://github.com/GoogleChrome/related-website-sets/blob/main/RWS-Submission_Guidelines.md">https://github.com/GoogleChrome/related-website-sets/blob/main/RWS-Submission_Guidelines.md</a>
  </dl>
  <h2 class="no-num no-ref heading settled" id="issues-index"><span class="content">Issues Index</span><a class="self-link" href="#issues-index"></a></h2>
  <div style="counter-reset:issue">
   <div class="issue"> Can we make a recommendation for an update interval here? <a href="https://github.com/wicg/first-party-sets/issues/122">[wicg/first-party-sets Issue #122]</a> <a class="issue-return" href="#issue-2f53edbf" title="Jump to section">↵</a></div>
   <div class="issue"> Client-side validation may be needed in cases where the <a data-link-type="biblio" href="#biblio-psl"><cite>Public Suffix List</cite></a> version differs between the server and client. <a href="https://github.com/wicg/first-party-sets/issues/125">[wicg/first-party-sets Issue #125]</a> <a class="issue-return" href="#issue-bb862ccb" title="Jump to section">↵</a></div>
   <div class="issue"> The specification currently suggests skipping invalid sets (missing primary entries) instead of rejecting the entire list. However, there may be benefit in a full rejection given that the server is expected to hold valid information at all times. <a href="https://github.com/wicg/first-party-sets/issues/126">[wicg/first-party-sets Issue #126]</a> <a class="issue-return" href="#issue-f434ab32" title="Jump to section">↵</a></div>
   <div class="issue"> Should this be renamed to avoid being confused with a mathematical equivalence relation? <a href="https://github.com/wicg/first-party-sets/issues/123">[wicg/first-party-sets Issue #123]</a> <a class="issue-return" href="#issue-7a693f54" title="Jump to section">↵</a></div>
   <div class="issue"> This section should provide more details on how user agents can figure out when a site leaves an RWS. <a href="https://github.com/wicg/first-party-sets/issues/124">[wicg/first-party-sets Issue #124]</a> <a class="issue-return" href="#issue-a87490bb" title="Jump to section">↵</a></div>
  </div>
<script>/* Boilerplate: script-dom-helper */
"use strict";
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}</script>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
let dfnPanelData = {
"0310eecd": {"dfnID":"0310eecd","dfnText":"name","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-permissiondescriptor-name"}],"title":"7. Handling related website set changes"}],"url":"https://w3c.github.io/permissions/#dom-permissiondescriptor-name"},
"03af1875": {"dfnID":"03af1875","dfnText":"permissions task source","external":true,"refSections":[{"refs":[{"id":"ref-for-permissions-task-source"}],"title":"6. Integration with the Storage Access API"}],"url":"https://w3c.github.io/permissions/#permissions-task-source"},
"0698d556": {"dfnID":"0698d556","dfnText":"string","external":true,"refSections":[{"refs":[{"id":"ref-for-string"}],"title":"4. Data Structures"}],"url":"https://infra.spec.whatwg.org/#string"},
"086e3aff": {"dfnID":"086e3aff","dfnText":"origin","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-origin"}],"title":"5. Validating related website set inclusion"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin"},
"09ba3f74": {"dfnID":"09ba3f74","dfnText":"requestStorageAccessFor(requestedOrigin)","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-document-requeststorageaccessfor"}],"title":"6. Integration with the Storage Access API"}],"url":"https://privacycg.github.io/requestStorageAccessFor/#dom-document-requeststorageaccessfor"},
"0a78af08": {"dfnID":"0a78af08","dfnText":"parse JSON bytes to an Infra value","external":true,"refSections":[{"refs":[{"id":"ref-for-parse-json-bytes-to-an-infra-value"}],"title":"3. List consumption"}],"url":"https://infra.spec.whatwg.org/#parse-json-bytes-to-an-infra-value"},
"0fda77ac": {"dfnID":"0fda77ac","dfnText":"clear cookies for origin","external":true,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-clear-cookies-for-origin"}],"title":"7. Handling related website set changes"}],"url":"https://www.w3.org/TR/clear-site-data/#abstract-opdef-clear-cookies-for-origin"},
"3a711be7": {"dfnID":"3a711be7","dfnText":"scheme","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-url-scheme"}],"title":"4. Data Structures"}],"url":"https://url.spec.whatwg.org/#concept-url-scheme"},
"3b90bdcd": {"dfnID":"3b90bdcd","dfnText":"resolve","external":true,"refSections":[{"refs":[{"id":"ref-for-resolve"}],"title":"6. Integration with the Storage Access API"}],"url":"https://webidl.spec.whatwg.org/#resolve"},
"3de9e659": {"dfnID":"3de9e659","dfnText":"byte sequence","external":true,"refSections":[{"refs":[{"id":"ref-for-byte-sequence"}],"title":"3. List consumption"}],"url":"https://infra.spec.whatwg.org/#byte-sequence"},
"3e12e042": {"dfnID":"3e12e042","dfnText":"environment settings object","external":true,"refSections":[{"refs":[{"id":"ref-for-environment-settings-object"},{"id":"ref-for-environment-settings-object\u2460"}],"title":"5. Validating related website set inclusion"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object"},
"43ac8374": {"dfnID":"43ac8374","dfnText":"origin (for environment settings object)","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-settings-object-origin"}],"title":"5. Validating related website set inclusion"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin"},
"48438eb3": {"dfnID":"48438eb3","dfnText":"queue a global task","external":true,"refSections":[{"refs":[{"id":"ref-for-queue-a-global-task"}],"title":"6. Integration with the Storage Access API"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task"},
"56736c6d": {"dfnID":"56736c6d","dfnText":"remove a permission store entry","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-remove-a-permission-store-entry"}],"title":"7. Handling related website set changes"}],"url":"https://w3c.github.io/permissions/#dfn-remove-a-permission-store-entry"},
"602b1a68": {"dfnID":"602b1a68","dfnText":"obtain a site","external":true,"refSections":[{"refs":[{"id":"ref-for-obtain-a-site"}],"title":"4. Data Structures"},{"refs":[{"id":"ref-for-obtain-a-site\u2460"},{"id":"ref-for-obtain-a-site\u2461"},{"id":"ref-for-obtain-a-site\u2462"},{"id":"ref-for-obtain-a-site\u2463"}],"title":"5. Validating related website set inclusion"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site"},
"649608b9": {"dfnID":"649608b9","dfnText":"list","external":true,"refSections":[{"refs":[{"id":"ref-for-list"},{"id":"ref-for-list\u2460"},{"id":"ref-for-list\u2461"},{"id":"ref-for-list\u2462"},{"id":"ref-for-list\u2463"},{"id":"ref-for-list\u2464"}],"title":"4. Data Structures"}],"url":"https://infra.spec.whatwg.org/#list"},
"6821ab89": {"dfnID":"6821ab89","dfnText":"granted","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-granted"}],"title":"6. Integration with the Storage Access API"}],"url":"https://w3c.github.io/permissions/#dfn-granted"},
"77a2ee6e": {"dfnID":"77a2ee6e","dfnText":"host","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-origin-host"},{"id":"ref-for-concept-origin-host\u2460"}],"title":"7. Handling related website set changes"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-host"},
"84b454ff": {"dfnID":"84b454ff","dfnText":"ordered map","external":true,"refSections":[{"refs":[{"id":"ref-for-ordered-map"}],"title":"3. List consumption"},{"refs":[{"id":"ref-for-ordered-map\u2460"}],"title":"4. Data Structures"}],"url":"https://infra.spec.whatwg.org/#ordered-map"},
"860300d4": {"dfnID":"860300d4","dfnText":"implementation-defined","external":true,"refSections":[{"refs":[{"id":"ref-for-implementation-defined"}],"title":"5. Validating related website set inclusion"},{"refs":[{"id":"ref-for-implementation-defined\u2460"}],"title":"7. Handling related website set changes"}],"url":"https://infra.spec.whatwg.org/#implementation-defined"},
"959ad97b": {"dfnID":"959ad97b","dfnText":"origin","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-url-origin"}],"title":"4. Data Structures"}],"url":"https://url.spec.whatwg.org/#concept-url-origin"},
"984221ca": {"dfnID":"984221ca","dfnText":"struct","external":true,"refSections":[{"refs":[{"id":"ref-for-struct"}],"title":"4. Data Structures"}],"url":"https://infra.spec.whatwg.org/#struct"},
"9b4f1943": {"dfnID":"9b4f1943","dfnText":"clear cache for origin","external":true,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-clear-cache-for-origin"}],"title":"7. Handling related website set changes"}],"url":"https://www.w3.org/TR/clear-site-data/#abstract-opdef-clear-cache-for-origin"},
"9c4c1e66": {"dfnID":"9c4c1e66","dfnText":"relevant settings object","external":true,"refSections":[{"refs":[{"id":"ref-for-relevant-settings-object"},{"id":"ref-for-relevant-settings-object\u2460"}],"title":"6. Integration with the Storage Access API"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object"},
"9ed8b710": {"dfnID":"9ed8b710","dfnText":"basic URL parser","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-basic-url-parser"}],"title":"4. Data Structures"}],"url":"https://url.spec.whatwg.org/#concept-basic-url-parser"},
"a0459604": {"dfnID":"a0459604","dfnText":"clear dom-accessible storage for origin","external":true,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-clear-dom-accessible-storage-for-origin"}],"title":"7. Handling related website set changes"}],"url":"https://www.w3.org/TR/clear-site-data/#abstract-opdef-clear-dom-accessible-storage-for-origin"},
"aa7820f7": {"dfnID":"aa7820f7","dfnText":"requestStorageAccess()","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-document-requeststorageaccess"}],"title":"6. Integration with the Storage Access API"}],"url":"https://privacycg.github.io/storage-access/#dom-document-requeststorageaccess"},
"aba5485c": {"dfnID":"aba5485c","dfnText":"registered domain","external":true,"refSections":[{"refs":[{"id":"ref-for-something"}],"title":"7. Handling related website set changes"}],"url":"https://publicsuffix.org/list/#"},
"are-same-party-in-an-embedding-context": {"dfnID":"are-same-party-in-an-embedding-context","dfnText":"are same-party in an embedding context","external":false,"refSections":[{"refs":[{"id":"ref-for-are-same-party-in-an-embedding-context"}],"title":"6. Integration with the Storage Access API"}],"url":"#are-same-party-in-an-embedding-context"},
"b01b1359": {"dfnID":"b01b1359","dfnText":"opaque origin","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-origin-opaque"}],"title":"7. Handling related website set changes"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque"},
"bffb633e": {"dfnID":"bffb633e","dfnText":"UTF-8","external":true,"refSections":[{"refs":[{"id":"ref-for-utf-8"}],"title":"3. List consumption"}],"url":"https://encoding.spec.whatwg.org/#utf-8"},
"build-the-list-of-related-website-sets": {"dfnID":"build-the-list-of-related-website-sets","dfnText":"build the list of related website sets","external":false,"refSections":[{"refs":[{"id":"ref-for-build-the-list-of-related-website-sets"}],"title":"3. List consumption"}],"url":"#build-the-list-of-related-website-sets"},
"c63519ed": {"dfnID":"c63519ed","dfnText":"top-level origin","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-environment-top-level-origin"},{"id":"ref-for-concept-environment-top-level-origin\u2460"}],"title":"5. Validating related website set inclusion"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin"},
"d357c753": {"dfnID":"d357c753","dfnText":"requesting permission to use","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-request-permission-to-use"},{"id":"ref-for-dfn-request-permission-to-use\u2460"}],"title":"6. Integration with the Storage Access API"}],"url":"https://w3c.github.io/permissions/#dfn-request-permission-to-use"},
"determine-eligibility-for-an-associated-site": {"dfnID":"determine-eligibility-for-an-associated-site","dfnText":"determine eligibility for an associated site","external":false,"refSections":[{"refs":[{"id":"ref-for-determine-eligibility-for-an-associated-site"},{"id":"ref-for-determine-eligibility-for-an-associated-site\u2460"},{"id":"ref-for-determine-eligibility-for-an-associated-site\u2461"}],"title":"5. Validating related website set inclusion"}],"url":"#determine-eligibility-for-an-associated-site"},
"determine-the-member-type": {"dfnID":"determine-the-member-type","dfnText":"determine the member type","external":false,"refSections":[{"refs":[{"id":"ref-for-determine-the-member-type"},{"id":"ref-for-determine-the-member-type\u2460"},{"id":"ref-for-determine-the-member-type\u2461"}],"title":"5. Validating related website set inclusion"}],"url":"#determine-the-member-type"},
"ebb01253": {"dfnID":"ebb01253","dfnText":"PermissionDescriptor","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-permissiondescriptor"}],"title":"7. Handling related website set changes"}],"url":"https://w3c.github.io/permissions/#dom-permissiondescriptor"},
"eligible-for-same-party-membership-when-embedded-within": {"dfnID":"eligible-for-same-party-membership-when-embedded-within","dfnText":"eligible for same-party membership when embedded within","external":false,"refSections":[{"refs":[{"id":"ref-for-eligible-for-same-party-membership-when-embedded-within"},{"id":"ref-for-eligible-for-same-party-membership-when-embedded-within\u2460"}],"title":"5. Validating related website set inclusion"}],"url":"#eligible-for-same-party-membership-when-embedded-within"},
"equivalence-map": {"dfnID":"equivalence-map","dfnText":"equivalence map","external":false,"refSections":[{"refs":[{"id":"ref-for-equivalence-map"},{"id":"ref-for-equivalence-map\u2460"}],"title":"4. Data Structures"},{"refs":[{"id":"ref-for-equivalence-map\u2461"}],"title":"5. Validating related website set inclusion"}],"url":"#equivalence-map"},
"equivalent-to": {"dfnID":"equivalent-to","dfnText":"equivalent to","external":false,"refSections":[{"refs":[{"id":"ref-for-equivalent-to"},{"id":"ref-for-equivalent-to\u2460"},{"id":"ref-for-equivalent-to\u2461"}],"title":"5. Validating related website set inclusion"}],"url":"#equivalent-to"},
"fb9bb722": {"dfnID":"fb9bb722","dfnText":"site","external":true,"refSections":[{"refs":[{"id":"ref-for-site"},{"id":"ref-for-site\u2460"},{"id":"ref-for-site\u2461"},{"id":"ref-for-site\u2462"},{"id":"ref-for-site\u2463"}],"title":"4. Data Structures"},{"refs":[{"id":"ref-for-site\u2464"},{"id":"ref-for-site\u2465"},{"id":"ref-for-site\u2466"},{"id":"ref-for-site\u2467"},{"id":"ref-for-site\u2468"},{"id":"ref-for-site\u2460\u24ea"},{"id":"ref-for-site\u2460\u2460"}],"title":"5. Validating related website set inclusion"},{"refs":[{"id":"ref-for-site\u2460\u2461"}],"title":"7. Handling related website set changes"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#site"},
"find-a-related-website-set": {"dfnID":"find-a-related-website-set","dfnText":"find a related website set","external":false,"refSections":[{"refs":[{"id":"ref-for-find-a-related-website-set"}],"title":"5. Validating related website set inclusion"}],"url":"#find-a-related-website-set"},
"is-same-party-with-its-top-level-embedder": {"dfnID":"is-same-party-with-its-top-level-embedder","dfnText":"is same-party with its top-level embedder","external":false,"refSections":[{"refs":[{"id":"ref-for-is-same-party-with-its-top-level-embedder"}],"title":"6. Integration with the Storage Access API"}],"url":"#is-same-party-with-its-top-level-embedder"},
"limit-for-associated-sites": {"dfnID":"limit-for-associated-sites","dfnText":"limit for associated sites","external":false,"refSections":[{"refs":[{"id":"ref-for-limit-for-associated-sites"}],"title":"5. Validating related website set inclusion"}],"url":"#limit-for-associated-sites"},
"list-of-related-website-sets": {"dfnID":"list-of-related-website-sets","dfnText":"list of related website sets","external":false,"refSections":[{"refs":[{"id":"ref-for-list-of-related-website-sets"},{"id":"ref-for-list-of-related-website-sets\u2460"}],"title":"3. List consumption"},{"refs":[{"id":"ref-for-list-of-related-website-sets\u2461"}],"title":"5. Validating related website set inclusion"},{"refs":[{"id":"ref-for-list-of-related-website-sets\u2462"}],"title":"7. Handling related website set changes"}],"url":"#list-of-related-website-sets"},
"parse-a-subset": {"dfnID":"parse-a-subset","dfnText":"parse a subset","external":false,"refSections":[{"refs":[{"id":"ref-for-parse-a-subset"},{"id":"ref-for-parse-a-subset\u2460"}],"title":"3. List consumption"}],"url":"#parse-a-subset"},
"parse-an-equivalence-map": {"dfnID":"parse-an-equivalence-map","dfnText":"parse an equivalence map","external":false,"refSections":[{"refs":[{"id":"ref-for-parse-an-equivalence-map"}],"title":"3. List consumption"}],"url":"#parse-an-equivalence-map"},
"parse-and-validate-a-site": {"dfnID":"parse-and-validate-a-site","dfnText":"parse and validate a site","external":false,"refSections":[{"refs":[{"id":"ref-for-parse-and-validate-a-site"},{"id":"ref-for-parse-and-validate-a-site\u2460"},{"id":"ref-for-parse-and-validate-a-site\u2461"}],"title":"4. Data Structures"}],"url":"#parse-and-validate-a-site"},
"related-website-set": {"dfnID":"related-website-set","dfnText":"related website set","external":false,"refSections":[{"refs":[{"id":"ref-for-related-website-set"}],"title":"3. List consumption"},{"refs":[{"id":"ref-for-related-website-set\u2460"}],"title":"4. Data Structures"},{"refs":[{"id":"ref-for-related-website-set\u2461"},{"id":"ref-for-related-website-set\u2462"},{"id":"ref-for-related-website-set\u2463"}],"title":"5. Validating related website set inclusion"},{"refs":[{"id":"ref-for-related-website-set\u2464"}],"title":"7. Handling related website set changes"}],"url":"#related-website-set"},
"related-website-set-associatedsites": {"dfnID":"related-website-set-associatedsites","dfnText":"associatedSites","external":false,"refSections":[{"refs":[{"id":"ref-for-related-website-set-associatedsites"}],"title":"3. List consumption"},{"refs":[{"id":"ref-for-related-website-set-associatedsites\u2460"},{"id":"ref-for-related-website-set-associatedsites\u2461"},{"id":"ref-for-related-website-set-associatedsites\u2462"}],"title":"5. Validating related website set inclusion"}],"url":"#related-website-set-associatedsites"},
"related-website-set-cctlds": {"dfnID":"related-website-set-cctlds","dfnText":"ccTLDs","external":false,"refSections":[{"refs":[{"id":"ref-for-related-website-set-cctlds"},{"id":"ref-for-related-website-set-cctlds\u2460"},{"id":"ref-for-related-website-set-cctlds\u2461"}],"title":"5. Validating related website set inclusion"}],"url":"#related-website-set-cctlds"},
"related-website-set-primary": {"dfnID":"related-website-set-primary","dfnText":"primary","external":false,"refSections":[{"refs":[{"id":"ref-for-related-website-set-primary"}],"title":"3. List consumption"},{"refs":[{"id":"ref-for-related-website-set-primary\u2460"}],"title":"5. Validating related website set inclusion"}],"url":"#related-website-set-primary"},
"related-website-set-servicesites": {"dfnID":"related-website-set-servicesites","dfnText":"serviceSites","external":false,"refSections":[{"refs":[{"id":"ref-for-related-website-set-servicesites"}],"title":"3. List consumption"},{"refs":[{"id":"ref-for-related-website-set-servicesites\u2460"}],"title":"5. Validating related website set inclusion"}],"url":"#related-website-set-servicesites"},
};

document.addEventListener("DOMContentLoaded", ()=>{
    genAllDfnPanels();

    document.body.addEventListener("click", (e) => {
        // If not handled already, just hide all dfn panels.
        hideAllDfnPanels();
    });
});

window.addEventListener("resize", () => {
    // Pin any visible dfn panel
    queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>positionDfnPanel(el));
});

function genAllDfnPanels() {
    for(const panelData of Object.values(dfnPanelData)) {
        const dfnID = panelData.dfnID;
        const dfn = document.getElementById(dfnID);
        if(!dfn) {
            console.log(`Can't find dfn#${dfnID}.`, panelData);
            continue;
        }
        dfn.panelData = panelData;
        insertDfnPopupAction(dfn);
    }
}

function genDfnPanel(dfn, { dfnID, url, dfnText, refSections, external }) {
    const dfnPanel = mk.aside({
        class: "dfn-panel on",
        id: `infopanel-for-${dfnID}`,
        "data-for": dfnID,
        "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
        },
        mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
            `Info about the '${dfnText}' ${external?"external":""} reference.`),
        mk.a({href:url, class:"dfn-link"}, url),
        refSections.length == 0 ? [] :
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({ href: `#${ref.id}` },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        genLinkingSyntaxes(dfn),
    );

    dfnPanel.addEventListener('click', (event) => {
        if (event.target.nodeName == 'A') {
            scrollToTargetAndHighlight(event);
            pinDfnPanel(dfnPanel);
        }
        event.stopPropagation();
        refocusOnTarget(event);
    });
    dfnPanel.addEventListener('keydown', (event) => {
        if(event.keyCode == 27) { // Escape key
            hideDfnPanel({dfnPanel});
            event.stopPropagation();
            event.preventDefault();
        }
    });

    dfnPanel.dfn = dfn;
    dfn.dfnPanel = dfnPanel;
    return dfnPanel;
}



function hideAllDfnPanels() {
    // Delete the currently-active dfn panel.
    queryAll(".dfn-panel").forEach(dfnPanel=>hideDfnPanel({dfnPanel}));
}

function showDfnPanel(dfn) {
    hideAllDfnPanels(); // Only display one at a time.

    dfn.setAttribute("aria-expanded", "true");

    const dfnPanel = genDfnPanel(dfn, dfn.panelData);

    // Give the dfn a unique tabindex, and then
    // give all the tabbable panel bits successive indexes.
    let tabIndex = 100;
    dfn.tabIndex = tabIndex++;
    const tabbable = dfnPanel.querySelectorAll(":is(a, button)");
    for (const el of tabbable) {
        el.tabIndex = tabIndex++;
    }

    append(document.body, dfnPanel);
    positionDfnPanel(dfnPanel);
}

function positionDfnPanel(dfnPanel) {
    const dfn = dfnPanel.dfn;
    const dfnPos = getBounds(dfn);
    dfnPanel.style.top = dfnPos.bottom + "px";
    dfnPanel.style.left = dfnPos.left + "px";

    const panelPos = dfnPanel.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, dfnPos.left - overflowAmount);
        dfnPanel.style.left = newLeft + "px";
    }
}

function pinDfnPanel(dfnPanel) {
    // Switch it to "activated" state, which pins it.
    dfnPanel.classList.add("activated");
    dfnPanel.style.position = "fixed";
    dfnPanel.style.left = null;
    dfnPanel.style.top = null;
}

function hideDfnPanel({dfn, dfnPanel}) {
    if(!dfnPanel) dfnPanel = dfn.dfnPanel;
    if(!dfn) dfn = dfnPanel.dfn;
    dfn.dfnPanel = undefined;
    dfnPanel.dfn = undefined;
    dfn.setAttribute("aria-expanded", "false");
    dfn.tabIndex = undefined;
    dfnPanel.remove()
}

function toggleDfnPanel(dfn) {
    if(dfn.dfnPanel) {
        hideDfnPanel(dfn);
    } else {
        showDfnPanel(dfn);
    }
}

function insertDfnPopupAction(dfn) {
    dfn.setAttribute('role', 'button');
    dfn.setAttribute('aria-expanded', 'false')
    dfn.tabIndex = 0;
    dfn.classList.add('has-dfn-panel');
    dfn.addEventListener('click', (event) => {
        toggleDfnPanel(dfn);
        event.stopPropagation();
    });
    dfn.addEventListener('keypress', (event) => {
        const kc = event.keyCode;
        // 32->Space, 13->Enter
        if(kc == 32 || kc == 13) {
            toggleDfnPanel(dfn);
            event.stopPropagation();
            event.preventDefault();
        }
    });
}

function refocusOnTarget(event) {
    const target = event.target;
    setTimeout(() => {
        // Refocus on the event.target element.
        // This is needed after browser scrolls to the destination.
        target.focus();
    });
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function scrollToTargetAndHighlight(event) {
    let hash = event.target.hash;
    if (hash) {
        hash = decodeURIComponent(hash.substring(1));
        const dest = document.getElementById(hash);
        if (dest) {
            dest.classList.add('highlighted');
            setTimeout(() => dest.classList.remove('highlighted'), 1000);
        }
    }
}

// Functions, divided by link type, that wrap an autolink's
// contents with the appropriate outer syntax.
// Alternately, a string naming another type they format
// the same as.
function needsFor(type) {
    switch(type) {
        case "descriptor":
        case "value":
        case "element-attr":
        case "attr-value":
        case "element-state":
        case "method":
        case "constructor":
        case "argument":
        case "attribute":
        case "const":
        case "dict-member":
        case "event":
        case "enum-value":
        case "stringifier":
        case "serializer":
        case "iterator":
        case "maplike":
        case "setlike":
        case "state":
        case "mode":
        case "context":
        case "facet": return true;

        default: return false;
    }
}
function refusesFor(type) {
    switch(type) {
        case "property":
        case "element":
        case "interface":
        case "namespace":
        case "callback":
        case "dictionary":
        case "enum":
        case "exception":
        case "typedef":
        case "http-header":
        case "permission": return true;

        default: return false;
    }
}
function linkFormatterFromType(type) {
    switch(type) {
        case 'scheme':
        case 'permission':
        case 'dfn': return (text) => `[=${text}=]`;

        case 'abstract-op': return (text) => `[\$${text}\$]`;

        case 'function':
        case 'at-rule':
        case 'selector':
        case 'value': return (text) => `''${text}''`;

        case 'http-header': return (text) => `[:${text}:]`;

        case 'interface':
        case 'constructor':
        case 'method':
        case 'argument':
        case 'attribute':
        case 'callback':
        case 'dictionary':
        case 'dict-member':
        case 'enum':
        case 'enum-value':
        case 'exception':
        case 'const':
        case 'typedef':
        case 'stringifier':
        case 'serializer':
        case 'iterator':
        case 'maplike':
        case 'setlike':
        case 'extended-attribute':
        case 'event':
        case 'idl': return (text) => `{{${text}}}`;

        case 'element-state':
        case 'element-attr':
        case 'attr-value':
        case 'element': return (element) => `<{${element}}>`;

        case 'grammar': return (text) => `${text} (within a <pre class=prod>)`;

        case 'type': return (text)=> `<<${text}>>`;

        case 'descriptor':
        case 'property': return (text) => `'${text}'`;

        default: return;
    };
};

function genLinkingSyntaxes(dfn) {
    if(dfn.tagName != "DFN") return;

    const type = dfn.getAttribute('data-dfn-type');
    if(!type) {
        console.log(`<dfn> doesn't have a data-dfn-type:`, dfn);
        return [];
    }

    // Return a function that wraps link text based on the type
    const linkFormatter = linkFormatterFromType(type);
    if(!linkFormatter) {
        console.log(`<dfn> has an unknown data-dfn-type:`, dfn);
        return [];
    }

    let ltAlts;
    if(dfn.hasAttribute('data-lt')) {
        ltAlts = dfn.getAttribute('data-lt')
            .split("|")
            .map(x=>x.trim());
    } else {
        ltAlts = [dfn.textContent.trim()];
    }
    if(type == "type") {
        // lt of "<foo>", but "foo" is the interior;
        // <<foo/bar>> is how you write it with a for,
        // not <foo/<bar>> or whatever.
        for(var i = 0; i < ltAlts.length; i++) {
            const lt = ltAlts[i];
            const match = /<(.*)>/.exec(lt);
            if(match) { ltAlts[i] = match[1]; }
        }
    }

    let forAlts;
    if(dfn.hasAttribute('data-dfn-for')) {
        forAlts = dfn.getAttribute('data-dfn-for')
            .split(",")
            .map(x=>x.trim());
    } else {
        forAlts = [''];
    }

    let linkingSyntaxes = [];
    if(!needsFor(type)) {
        for(const lt of ltAlts) {
            linkingSyntaxes.push(linkFormatter(lt));
        }
    }
    if(!refusesFor(type)) {
        for(const f of forAlts) {
            linkingSyntaxes.push(linkFormatter(`${f}/${ltAlts[0]}`))
        }
    }
    return [
        mk.b({}, 'Possible linking syntaxes:'),
        mk.ul({},
            ...linkingSyntaxes.map(link => {
                const copyLink = async () =>
                    await navigator.clipboard.writeText(link);
                return mk.li({},
                    mk.div({ class: 'link-item' },
                        mk.button({
                            class: 'copy-icon', title: 'Copy',
                            type: 'button',
                            _onclick: copyLink,
                            tabindex: 0,
                        }, mk.span({ class: 'icon' }) ),
                        mk.span({}, link)
                    )
                );
            })
        )
    ];
}
}
</script>
<script>/* Boilerplate: script-ref-hints */
"use strict";
{
let refsData = {
"#are-same-party-in-an-embedding-context": {"displayText":"are same-party in an embedding context","export":true,"for_":[],"level":"","normative":true,"shortname":"first-party-sets","spec":"first-party-sets","status":"local","text":"are same-party in an embedding context","type":"dfn","url":"#are-same-party-in-an-embedding-context"},
"#build-the-list-of-related-website-sets": {"displayText":"build the list of related website sets","export":true,"for_":[],"level":"","normative":true,"shortname":"first-party-sets","spec":"first-party-sets","status":"local","text":"build the list of related website sets","type":"dfn","url":"#build-the-list-of-related-website-sets"},
"#determine-eligibility-for-an-associated-site": {"displayText":"determine eligibility for an associated site","export":true,"for_":[],"level":"","normative":true,"shortname":"first-party-sets","spec":"first-party-sets","status":"local","text":"determine eligibility for an associated site","type":"dfn","url":"#determine-eligibility-for-an-associated-site"},
"#determine-the-member-type": {"displayText":"determine the member type","export":true,"for_":[],"level":"","normative":true,"shortname":"first-party-sets","spec":"first-party-sets","status":"local","text":"determine the member type","type":"dfn","url":"#determine-the-member-type"},
"#eligible-for-same-party-membership-when-embedded-within": {"displayText":"eligible for same-party membership when embedded within","export":true,"for_":[],"level":"","normative":true,"shortname":"first-party-sets","spec":"first-party-sets","status":"local","text":"eligible for same-party membership when embedded within","type":"dfn","url":"#eligible-for-same-party-membership-when-embedded-within"},
"#equivalence-map": {"displayText":"equivalence map","export":true,"for_":[],"level":"","normative":true,"shortname":"first-party-sets","spec":"first-party-sets","status":"local","text":"equivalence map","type":"dfn","url":"#equivalence-map"},
"#equivalent-to": {"displayText":"equivalent to","export":true,"for_":[],"level":"","normative":true,"shortname":"first-party-sets","spec":"first-party-sets","status":"local","text":"equivalent to","type":"dfn","url":"#equivalent-to"},
"#find-a-related-website-set": {"displayText":"find a related website set","export":true,"for_":[],"level":"","normative":true,"shortname":"first-party-sets","spec":"first-party-sets","status":"local","text":"find a related website set","type":"dfn","url":"#find-a-related-website-set"},
"#is-same-party-with-its-top-level-embedder": {"displayText":"is same-party with its top-level embedder","export":true,"for_":[],"level":"","normative":true,"shortname":"first-party-sets","spec":"first-party-sets","status":"local","text":"is same-party with its top-level embedder","type":"dfn","url":"#is-same-party-with-its-top-level-embedder"},
"#limit-for-associated-sites": {"displayText":"limit for associated sites","export":true,"for_":[],"level":"","normative":true,"shortname":"first-party-sets","spec":"first-party-sets","status":"local","text":"limit for associated sites","type":"dfn","url":"#limit-for-associated-sites"},
"#list-of-related-website-sets": {"displayText":"list of related website sets","export":true,"for_":[],"level":"","normative":true,"shortname":"first-party-sets","spec":"first-party-sets","status":"local","text":"list of related website sets","type":"dfn","url":"#list-of-related-website-sets"},
"#parse-a-subset": {"displayText":"parse a subset","export":true,"for_":[],"level":"","normative":true,"shortname":"first-party-sets","spec":"first-party-sets","status":"local","text":"parse a subset","type":"dfn","url":"#parse-a-subset"},
"#parse-an-equivalence-map": {"displayText":"parse an equivalence map","export":true,"for_":[],"level":"","normative":true,"shortname":"first-party-sets","spec":"first-party-sets","status":"local","text":"parse an equivalence map","type":"dfn","url":"#parse-an-equivalence-map"},
"#parse-and-validate-a-site": {"displayText":"parse and validate a site","export":true,"for_":[],"level":"","normative":true,"shortname":"first-party-sets","spec":"first-party-sets","status":"local","text":"parse and validate a site","type":"dfn","url":"#parse-and-validate-a-site"},
"#related-website-set": {"displayText":"related website set","export":true,"for_":[],"level":"","normative":true,"shortname":"first-party-sets","spec":"first-party-sets","status":"local","text":"related website set","type":"dfn","url":"#related-website-set"},
"#related-website-set-associatedsites": {"displayText":"associatedsites","export":true,"for_":["related website set"],"level":"","normative":true,"shortname":"first-party-sets","spec":"first-party-sets","status":"local","text":"associatedsites","type":"dfn","url":"#related-website-set-associatedsites"},
"#related-website-set-cctlds": {"displayText":"cctlds","export":true,"for_":["related website set"],"level":"","normative":true,"shortname":"first-party-sets","spec":"first-party-sets","status":"local","text":"cctlds","type":"dfn","url":"#related-website-set-cctlds"},
"#related-website-set-primary": {"displayText":"primary","export":true,"for_":["related website set"],"level":"","normative":true,"shortname":"first-party-sets","spec":"first-party-sets","status":"local","text":"primary","type":"dfn","url":"#related-website-set-primary"},
"#related-website-set-servicesites": {"displayText":"servicesites","export":true,"for_":["related website set"],"level":"","normative":true,"shortname":"first-party-sets","spec":"first-party-sets","status":"local","text":"servicesites","type":"dfn","url":"#related-website-set-servicesites"},
"https://encoding.spec.whatwg.org/#utf-8": {"displayText":"UTF-8","export":true,"for_":[],"level":"1","normative":true,"shortname":"encoding","spec":"encoding","status":"current","text":"utf-8","type":"dfn","url":"https://encoding.spec.whatwg.org/#utf-8"},
"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin": {"displayText":"origin","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin"},
"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-host": {"displayText":"host","export":true,"for_":["origin"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"host","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-host"},
"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque": {"displayText":"opaque origin","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"opaque origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque"},
"https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site": {"displayText":"obtain a site","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"obtain a site","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site"},
"https://html.spec.whatwg.org/multipage/browsers.html#site": {"displayText":"site","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"site","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#site"},
"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin": {"displayText":"top-level origin","export":true,"for_":["environment"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"top-level origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin"},
"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin": {"displayText":"origin","export":true,"for_":["environment settings object"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin"},
"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object": {"displayText":"environment settings object","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"environment settings object","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object"},
"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task": {"displayText":"queue a global task","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"queue a global task","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task"},
"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object": {"displayText":"relevant settings object","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"relevant settings object","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object"},
"https://infra.spec.whatwg.org/#byte-sequence": {"displayText":"byte sequence","export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"byte sequence","type":"dfn","url":"https://infra.spec.whatwg.org/#byte-sequence"},
"https://infra.spec.whatwg.org/#implementation-defined": {"displayText":"implementation-defined","export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"implementation-defined","type":"dfn","url":"https://infra.spec.whatwg.org/#implementation-defined"},
"https://infra.spec.whatwg.org/#list": {"displayText":"list","export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"list","type":"dfn","url":"https://infra.spec.whatwg.org/#list"},
"https://infra.spec.whatwg.org/#ordered-map": {"displayText":"ordered map","export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"ordered map","type":"dfn","url":"https://infra.spec.whatwg.org/#ordered-map"},
"https://infra.spec.whatwg.org/#parse-json-bytes-to-an-infra-value": {"displayText":"parse JSON bytes to an Infra value","export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"parse json bytes to an infra value","type":"dfn","url":"https://infra.spec.whatwg.org/#parse-json-bytes-to-an-infra-value"},
"https://infra.spec.whatwg.org/#string": {"displayText":"string","export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"string","type":"dfn","url":"https://infra.spec.whatwg.org/#string"},
"https://infra.spec.whatwg.org/#struct": {"displayText":"struct","export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"struct","type":"dfn","url":"https://infra.spec.whatwg.org/#struct"},
"https://privacycg.github.io/requestStorageAccessFor/#dom-document-requeststorageaccessfor": {"displayText":"requestStorageAccessFor(requestedOrigin)","export":true,"for_":["Document"],"level":"1","normative":true,"shortname":"requeststorageaccessfor","spec":"requeststorageaccessfor","status":"current","text":"requestStorageAccessFor(requestedOrigin)","type":"method","url":"https://privacycg.github.io/requestStorageAccessFor/#dom-document-requeststorageaccessfor"},
"https://privacycg.github.io/storage-access/#dom-document-requeststorageaccess": {"displayText":"requestStorageAccess()","export":true,"for_":["Document"],"level":"1","normative":true,"shortname":"storage-access","spec":"storage-access","status":"current","text":"requestStorageAccess()","type":"method","url":"https://privacycg.github.io/storage-access/#dom-document-requeststorageaccess"},
"https://publicsuffix.org/list/#": {"displayText":"registered domain","export":true,"for_":[],"level":"","normative":true,"shortname":"psl","spec":"psl","status":"anchor-block","text":"registered domain","type":"dfn","url":"https://publicsuffix.org/list/#"},
"https://url.spec.whatwg.org/#concept-basic-url-parser": {"displayText":"basic URL parser","export":true,"for_":[],"level":"1","normative":true,"shortname":"url","spec":"url","status":"current","text":"basic url parser","type":"dfn","url":"https://url.spec.whatwg.org/#concept-basic-url-parser"},
"https://url.spec.whatwg.org/#concept-url-origin": {"displayText":"origin","export":true,"for_":["url"],"level":"1","normative":true,"shortname":"url","spec":"url","status":"current","text":"origin","type":"dfn","url":"https://url.spec.whatwg.org/#concept-url-origin"},
"https://url.spec.whatwg.org/#concept-url-scheme": {"displayText":"scheme","export":true,"for_":["url"],"level":"1","normative":true,"shortname":"url","spec":"url","status":"current","text":"scheme","type":"dfn","url":"https://url.spec.whatwg.org/#concept-url-scheme"},
"https://w3c.github.io/permissions/#dfn-granted": {"displayText":"granted","export":true,"for_":["permission"],"level":"1","normative":true,"shortname":"permissions","spec":"permissions","status":"current","text":"granted","type":"dfn","url":"https://w3c.github.io/permissions/#dfn-granted"},
"https://w3c.github.io/permissions/#dfn-remove-a-permission-store-entry": {"displayText":"remove a permission store entry","export":true,"for_":[],"level":"1","normative":true,"shortname":"permissions","spec":"permissions","status":"current","text":"remove a permission store entry","type":"dfn","url":"https://w3c.github.io/permissions/#dfn-remove-a-permission-store-entry"},
"https://w3c.github.io/permissions/#dfn-request-permission-to-use": {"displayText":"requesting permission to use","export":true,"for_":[],"level":"1","normative":true,"shortname":"permissions","spec":"permissions","status":"current","text":"requesting permission to use","type":"dfn","url":"https://w3c.github.io/permissions/#dfn-request-permission-to-use"},
"https://w3c.github.io/permissions/#dom-permissiondescriptor": {"displayText":"PermissionDescriptor","export":true,"for_":[],"level":"1","normative":true,"shortname":"permissions","spec":"permissions","status":"current","text":"PermissionDescriptor","type":"dictionary","url":"https://w3c.github.io/permissions/#dom-permissiondescriptor"},
"https://w3c.github.io/permissions/#dom-permissiondescriptor-name": {"displayText":"name","export":true,"for_":["PermissionDescriptor"],"level":"1","normative":true,"shortname":"permissions","spec":"permissions","status":"current","text":"name","type":"dict-member","url":"https://w3c.github.io/permissions/#dom-permissiondescriptor-name"},
"https://w3c.github.io/permissions/#permissions-task-source": {"displayText":"permissions task source","export":true,"for_":[],"level":"","normative":true,"shortname":"permissions","spec":"permissions","status":"anchor-block","text":"permissions task source","type":"dfn","url":"https://w3c.github.io/permissions/#permissions-task-source"},
"https://webidl.spec.whatwg.org/#resolve": {"displayText":"resolve","export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"resolve","type":"dfn","url":"https://webidl.spec.whatwg.org/#resolve"},
"https://www.w3.org/TR/clear-site-data/#abstract-opdef-clear-cache-for-origin": {"displayText":"clear cache for origin","export":true,"for_":[],"level":"","normative":true,"shortname":"clear-site-data","spec":"clear-site-data","status":"anchor-block","text":"clear cache for origin","type":"dfn","url":"https://www.w3.org/TR/clear-site-data/#abstract-opdef-clear-cache-for-origin"},
"https://www.w3.org/TR/clear-site-data/#abstract-opdef-clear-cookies-for-origin": {"displayText":"clear cookies for origin","export":true,"for_":[],"level":"","normative":true,"shortname":"clear-site-data","spec":"clear-site-data","status":"anchor-block","text":"clear cookies for origin","type":"dfn","url":"https://www.w3.org/TR/clear-site-data/#abstract-opdef-clear-cookies-for-origin"},
"https://www.w3.org/TR/clear-site-data/#abstract-opdef-clear-dom-accessible-storage-for-origin": {"displayText":"clear dom-accessible storage for origin","export":true,"for_":[],"level":"","normative":true,"shortname":"clear-site-data","spec":"clear-site-data","status":"anchor-block","text":"clear dom-accessible storage for origin","type":"dfn","url":"https://www.w3.org/TR/clear-site-data/#abstract-opdef-clear-dom-accessible-storage-for-origin"},
};

function mkRefHint(link, ref) {
    const linkText = link.textContent;
    let dfnTextElements = '';
    if (ref.displayText.toLowerCase() != linkText.toLowerCase()) {
        // Give the original term if it's being displayed in a different way.
        // But allow casing differences, they're insignificant.
        dfnTextElements =
            mk.li({},
                mk.b({}, "Term: "),
                mk.span({}, ref.displayText)
            );
    }
    const forList = ref.for_;
    let forListElements;
    if(forList.length == 0) {
        forListElements = [];
    } else if(forList.length == 1) {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.span({}, forList[0]),
        );
    } else {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.ul({},
                ...forList.map(forItem =>
                    mk.li({},
                        mk.span({}, forItem)
                    ),
                ),
            ),
        );
    }
    const url = ref.url;
    const safeUrl = encodeURIComponent(url);
    const hintPanel = mk.aside({
        class: "ref-hint",
        id: `ref-hint-for-${safeUrl}`,
        "data-for": url,
        "aria-labelled-by": `ref-hint-for-${safeUrl}`,
    },
        mk.ul({},
            dfnTextElements,
            mk.li({},
                mk.b({}, "URL: "),
                mk.a({ href: url, class: "ref" }, url),
            ),
            mk.li({},
                mk.b({}, "Type: "),
                mk.span({}, `${ref.type}`),
            ),
            mk.li({},
                mk.b({}, "Spec: "),
                mk.span({}, `${ref.spec ? ref.spec : ''}`),
            ),
            forListElements
        ),
    );
    hintPanel.forLink = link;
    setupRefHintEventListeners(link, hintPanel);
    return hintPanel;
}

function hideAllRefHints() {
    queryAll(".ref-hint").forEach(el=>hideRefHint(el));
}

function hideRefHint(refHint) {
    const link = refHint.forLink;
    link.setAttribute("aria-expanded", "false");
    if(refHint.teardownEventListeners) {
        refHint.teardownEventListeners();
    }
    refHint.remove();
}

function showRefHint(link) {
    if(link.classList.contains("dfn-link")) return;
    const url = link.getAttribute("href");
    const refHintKey = link.getAttribute("data-refhint-key");
    let key = url;
    if(refHintKey) {
        key = refHintKey + "_" + url;
    }
    const ref = refsData[key];
    if(!ref) return;

    hideAllRefHints(); // Only display one at this time.

    const refHint = mkRefHint(link, ref);
    append(document.body, refHint);
    link.setAttribute("aria-expanded", "true");
    positionRefHint(refHint);
}

function setupRefHintEventListeners(link, refHint) {
    if (refHint.teardownEventListeners) return;
    // Add event handlers to hide the refHint after the user moves away
    // from both the link and refHint, if not hovering either within one second.
    let timeout = null;
    const startHidingRefHint = (event) => {
        if (timeout) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(() => {
            hideRefHint(refHint);
        }, 1000);
    }
    const resetHidingRefHint = (event) => {
        if (timeout) clearTimeout(timeout);
        timeout = null;
    };
    link.addEventListener("mouseleave", startHidingRefHint);
    link.addEventListener("mouseenter", resetHidingRefHint);
    link.addEventListener("blur", startHidingRefHint);
    link.addEventListener("focus", resetHidingRefHint);
    refHint.addEventListener("mouseleave", startHidingRefHint);
    refHint.addEventListener("mouseenter", resetHidingRefHint);
    refHint.addEventListener("blur", startHidingRefHint);
    refHint.addEventListener("focus", resetHidingRefHint);

    refHint.teardownEventListeners = () => {
        // remove event listeners
        resetHidingRefHint();
        link.removeEventListener("mouseleave", startHidingRefHint);
        link.removeEventListener("mouseenter", resetHidingRefHint);
        link.removeEventListener("blur", startHidingRefHint);
        link.removeEventListener("focus", resetHidingRefHint);
        refHint.removeEventListener("mouseleave", startHidingRefHint);
        refHint.removeEventListener("mouseenter", resetHidingRefHint);
        refHint.removeEventListener("blur", startHidingRefHint);
        refHint.removeEventListener("focus", resetHidingRefHint);
    };
}

function positionRefHint(refHint) {
    const link = refHint.forLink;
    const linkPos = getBounds(link);
    refHint.style.top = linkPos.bottom + "px";
    refHint.style.left = linkPos.left + "px";

    const panelPos = refHint.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, linkPos.left - overflowAmount);
        refHint.style.left = newLeft + "px";
    }
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function showRefHintListener(e) {
    // If the target isn't in a link (or is a link),
    // just ignore it.
    let link = e.target.closest("a");
    if(!link) return;

    // If the target is in a ref-hint panel
    // (aka a link in the already-open one),
    // also just ignore it.
    if(link.closest(".ref-hint")) return;

    // Otherwise, show the panel for the link.
    showRefHint(link);
}

function hideAllHintsListener(e) {
    // If the click is inside a ref-hint panel, ignore it.
    if(e.target.closest(".ref-hint")) return;
    // Otherwise, close all the current panels.
    hideAllRefHints();
}

document.addEventListener("DOMContentLoaded", () => {
    document.body.addEventListener("mousedown", showRefHintListener);
    document.body.addEventListener("focus", showRefHintListener);

    document.body.addEventListener("click", hideAllHintsListener);
});

window.addEventListener("resize", () => {
    // Hide any open ref hint.
    hideAllRefHints();
});
}
</script>